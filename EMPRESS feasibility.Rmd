---
title: "EMPRESS feasibility script"
author: "NM"
date: "2026-01-15"
output: html_document
---

## 1.0 Load libraries

```{r include=FALSE}
library(nanoparquet)
library(tidyverse)
library(openxlsx)
library(stringi)
library(janitor)
library(uuid)
```

## 2.0 Load data

```{r include=FALSE}
# -------- Paths to exported data files --------
data_dir <- "C:/Users/nmei0013/Downloads"
f_forms <- file.path(data_dir, "export-export_forms_empress_domain_20260120103346.parquet")
f_events <- file.path(data_dir, "export-export_events_empress_platform_20260120103321.parquet")
allocation <- file.path(data_dir, "export-export_allocations_empress_domain_20260120103346.parquet")

# -------- Load data from parquet files --------
EMPRESS_forms <- read_parquet(f_forms)
EMPRESS_events <- read_parquet(f_events)
EMPRESS_allocation <- read_parquet(allocation)
```

## 3.0 Data validation

### 3.x Code for safety report included cut off

```{r eval=FALSE, include=FALSE}
#------------------------------------------------------------
# 1) Cutoff date
#------------------------------------------------------------
Safety_trigger_date <- date("2026-02-18")
cuttoff_date <- Safety_trigger_date - days(105) + 1

#------------------------------------------------------------
# 2) Subset of enrolled participants in EMPRESS <= cuttoff_date
#------------------------------------------------------------
EMPRESS_master_safety <- EMPRESS_events %>% 
  filter(
      event_type_name == "enrolment" &
      event_description == "empress_platform" &
      
    # Local datetime for enrolment before cuttoff date
      date(with_tz(timestamp, "Europe/Copenhagen")) <= cuttoff_date 
  ) %>% 
  
  # Rename timestamp to rand_datetime_utc
  rename(
    rand_datetime_utc = timestamp,
         ) %>% 
  
  # Keep only relevant colums
  select(ssid, enrolment_site, rand_datetime_utc)
```

### 3.1 Creation of master dataframe consisting of 200 first enrolled (feasibility)

```{r}
EMPRESS_master_feasibility <- EMPRESS_events %>% 
  # keep only enrolment rows
  filter(str_detect(event_type_name, "enrolment")) %>% 
  
  # order by time to pick the FIRST 200 enrolled participants
  arrange(timestamp) %>% 
  
  # pick first 200 unique ssid
  distinct(ssid, .keep_all = TRUE) %>% 
  slice_head(n = 200) %>% 
  
  # rename timestamp and event_id
  rename(
    rand_datetime_utc = timestamp,
    rand_datetime_id  = event_id
  ) %>% 
  
  # convert UTC to local datetime
  mutate(
    rand_datetime_local = with_tz(rand_datetime_utc, "Europe/Copenhagen")
  ) %>% 
  
  # keep only relevant columns
  select(
    ssid,
    enrolment_site,
    rand_datetime_utc
  )
```

### 3.2 Removal of unwanted spillovers and uuid

```{r}
#------------------------------------------------------------
# 1) Scan for Pyhton spill-over
#------------------------------------------------------------
py_obj_summary_forms <- EMPRESS_forms %>% 
  mutate(value_chr = as.character(value)) %>% 
  summarise(
    n_py_object = sum(str_detect(value_chr, "<object\\s"), na.rm = TRUE),
    .by = variable_name
  ) %>% 
  filter(n_py_object > 0) %>% 
  arrange(desc(n_py_object))

#------------------------------------------------------------
# 2) Query-ready table of affected rows
#------------------------------------------------------------
py_obj_rows_forms <- EMPRESS_forms %>%
  mutate(value_chr = as.character(value)) %>%
  filter(str_detect(value_chr, "^<object object at 0x[0-9a-fA-F]+>$")) %>%
  transmute(
    ssid, responsible_site, form_layout, start_datetime, end_datetime,
    variable_name, value = value_chr
  )

#------------------------------------------------------------
# 2) Clean forms data from python spill-over
#------------------------------------------------------------
EMPRESS_forms <- EMPRESS_forms %>%
  mutate(
    value_chr = stringr::str_squish(as.character(value)),
    value_chr = dplyr::if_else(
      stringr::str_detect(value_chr, "^<object object at 0x[0-9a-fA-F]+>$"),
      NA_character_,
      value_chr
    ),
    value = value_chr
  ) %>%
  select(-value_chr)

#------------------------------------------------------------
# 3) Scan for UUID
#------------------------------------------------------------
uuid_obj_summary_forms <- EMPRESS_forms %>% 
  mutate(value_chr = str_squish(as.character(value))) %>% 
  summarise(
    n_UUID_object = sum(UUIDvalidate(value_chr), na.rm = TRUE),
    .by = variable_name
  ) %>% 
  filter(n_UUID_object > 0) %>% 
  arrange(desc(n_UUID_object))

#------------------------------------------------------------
# 4) Query-ready table of affected rows
#------------------------------------------------------------
uuid_obj_rows_forms <- EMPRESS_forms %>%
  mutate(value_chr = str_squish(as.character(value))) %>%
  filter(UUIDvalidate(value_chr) == TRUE) %>% 
  transmute(
    ssid, responsible_site, form_layout, start_datetime, end_datetime,
    variable_name, value = value_chr
  )

#------------------------------------------------------------
# 5) Clean forms data from python spill-over
#------------------------------------------------------------
EMPRESS_forms <- EMPRESS_forms %>%
  mutate(
    value_chr = str_squish(as.character(value)),
    value_chr = if_else(
      UUIDvalidate(value_chr) == TRUE, 
      NA_character_,
      value_chr
    ),
    value = value_chr
  ) %>%
  select(-value_chr)

rm(
  py_obj_rows_forms,
  py_obj_summary_forms,
  uuid_obj_rows_forms,
  uuid_obj_summary_forms
)
```

### 3.3 Screening variables subset

```{r}
#------------------------------------------------------------
# 1) Preparing screening subset
#------------------------------------------------------------
EMPRESS_forms_screening <- EMPRESS_forms %>% 
  filter( # relevant form_layout and variables
    form_layout == "empress_domain_screening" & 
    variable_name %in% c(
      # Inclusion criteria
      "age_ge_18",
      "sepsis",
      "indication_for_empirical_antibiotics",
      "acutely_critically_ill",
      # Exclusion criteria
      "infection_multiresistent_bacteria",
      "use_of_valproat",
      "pregnant",
      "suspected_cns_infection",
      "allergic_to_betalactam_antibiotics",
      "preceding_iv_antibiotics",
      "co_enrolment_with_empress_not_possible",
      "informed_content_unobtainable",
      "coercive_measures")
  ) %>% 
  select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value
  )
```

### 3.4 Baseline variables (and baseline-like screening variables) subet

```{r}
#------------------------------------------------------------
# 1) Preparing baseline subset
#------------------------------------------------------------
EMPRESS_forms_baseline <- EMPRESS_forms %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter( 
    # baseline-like variables from screening forms
    (form_layout == "empress_domain_screening" & 
    variable_name %in% c(
      "haematological_or_metastatic_cancer",
      "date_of_birth",
      "acute_surgical_admission",
      "use_of_respiratory_support_at_randomisation",
      "use_of_circulatory_support_at_randomisation",
      "rrt_within_72h_before_randomisation")) |
    # baseline variables
    (form_layout == "empress_baseline" &
    variable_name %in% c(
      "ischemic_heart_disease",
      "diabetes",
      "chronic_pulmonary_disease",
      "chronic_liver_disease",
      "immunosuppression",
      "organ_transplantation",
      "chronic_rrt",
      "sex",
      "clinical_frailty_scale",
      "date_of_index_hospital_admission",
      "department_at_which_the_participant_was_included",
      "weight",
      "heigh",
      "systolic_blood_pressure_lowest",
      "primary_site_of_infection",
      "positive_bacterial_culture",
      "type_of_sample",
      "type_of_bacteria",
      "resistance_to_piperacillin_tazobactam",
      "resistance_to_meropenem",
      "use_of_respiratory_support_at_randomisation",
      "type_of_respiratory_support",
      "fio2_before_randomisation",
      "max_oxygen_flow_at_randomisation",
      "treatment_with_antibacterial_agent_prior_to_randomisation",
      "anti_bacterial_agent",
      "use_of_systemic_corticosteroids_at_randomisation",
      "arterial_blood_gas_available",
      "arterial_oxygen_saturation ",
      "pao2",
      "peripheral_oxygen_saturation",
      "lactate_highest",
      "creatinine_highest",
      "limitations_of_care"))
    ) %>%  
    select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value
    )
```

### 3.5 Dayform variables subset

```{r}
#------------------------------------------------------------
# 1) Preparing dayform subset
#------------------------------------------------------------
EMPRESS_forms_dayforms <- EMPRESS_forms %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter( 
    # baseline form layouts from the export
    form_layout %in% c(
      "empress_dayform_1_to_30",
      "empress_dayform_1_to_90",
      "empress_dayform_non_trial_site_1_to_30",
      "empress_dayform_non_trial_site_1_to_90") &
      variable_name %in% c(
        # Dayform 1 - 30 on non-trial site
        "isolation_due_to_resistant_bacteria",
        "type_of_resistant_bacteria_new",
        "antibiotic_agent_to_which_the_bacteria_was_resistant",
        "invasive_mechanical_ventilation",
        "circulatory_support_min_1h",
        "any_rrt_this_day",
        "anaphylactic_shock_piptazo_meropenem",
        "invasive_fungal_infection",
        "pseudomembranous_colitis",
        "toxic_epidermal_necrolysis",
        
        # Dayform 1 on trial site dayform
        "dosing_regimen",
        
        # Dayform 1 - 30 on trial site
        "did_the_patient_receive_at_least_50percent_of_the_prescribed_daily_dose",
        "reason_for_not_receiving_at_least_50_percent",
        "use_of_any_another_antibiotic_agent_than_allocated_on_this_day",
        "other_antibiotic_agent_than_allocated_type_treatment",
        "other_antibiotic_agent_than_allocated_type_agent",
        
        # Dayform 31 - 90 on both trial and non-trial 
        "invasive_mechanical_ventilation",
        "circulatory_support_min_1h",
        "any_rrt_this_day"
        )
  ) %>%  
  select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value
  )
```

### 3.6 Followup variables subset

```{r}
#------------------------------------------------------------
# 1) Preparing followup 30/90 days subset
#------------------------------------------------------------
EMPRESS_forms_followup <- EMPRESS_forms %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter(form_layout == "empress_30_90_days_followup" &
         variable_name == "30_90_day_followup") %>% 
  select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value)
```

### 3.7 Combining all subsets

```{r}
#------------------------------------------------------------
# 1) Combining the different dataframes for all participants
#------------------------------------------------------------
EMPRESS_forms_all <- bind_rows(
  EMPRESS_forms_screening,
  EMPRESS_forms_baseline, 
  EMPRESS_forms_dayforms,
  EMPRESS_forms_followup
  )
```

### 3.8 Enrolled events

```{r}
#------------------------------------------------------------
# 1) Subset events on enrolled participants
#------------------------------------------------------------
EMPRESS_events_enrol <- EMPRESS_events %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%
  mutate(source = "empress_events")
 
#------------------------------------------------------------
# 2) All events
#    - Creating responsible site for events
#------------------------------------------------------------
events_master_enrol <- EMPRESS_events_enrol %>% 
  mutate(
    responsible_site = case_when(
      event_type_name == "enrolment" ~ str_squish(as.character(enrolment_site)),
      event_type_name == "relocate"  ~ str_to_lower(str_squish(str_extract(as.character(event_description), "^[^/]+"))),
      TRUE ~ NA_character_
    )
  ) %>% 
  group_by(ssid) %>%
  arrange(desc(enrolment_site), timestamp, .by_group = TRUE) %>%
  fill(responsible_site, .direction = "down") %>%
  ungroup() %>% 
  select(-enrolment_site)
```

## 4.0 Data cleaning

### 4.1 Helper functions

```{r}
# Helper 1: detect missing 
na_blank <- function(x) {
  x <- str_squish(as.character(x))
  x[x %in% c("", "NA", "NaN", "None", "na", "none", "nan")] <- NA_character_
  x
}

# Helper 2: to numeric
to_numeric <- function(x) {

  if (is.numeric(x)) return(x)

  x_chr <- str_to_lower(str_squish(as.character(x)))

  # Explicit missing encodings
  x_chr[x_chr %in% c("", "NA", "NaN", "None", "na", "none", "nan")] <- NA_character_

  # Allow signed numeric values (incl. negatives)
  is_num <- stringr::str_detect(
    x_chr,
    "^[-+]?[0-9]*\\.?[0-9]+$"
  )
  is_num[is.na(is_num)] <- FALSE

  out <- rep(NA_real_, length(x_chr))
  out[is_num] <- as.numeric(x_chr[is_num])

  out
}

# Helper 3
to_bool <- function(x) {
  x <- tolower(trimws(as.character(x)))
  dplyr::case_when(
    x %in% c("true","t","1","yes","y")  ~ TRUE,
    x %in% c("false","f","0","no","n")  ~ FALSE,
    TRUE ~ NA
  )
}
```

### 4.2 Outliers

#### 4.2.1 Outliers by hard/soft boundries

```{r}
# -------------------------------------------------
# 1) Define validation rules for baseline and baseline-like variables
# -------------------------------------------------

# Hard bounds = impossible/outside absolute physiological or data constraints
# Soft bounds = clinically implausible (flag for review), but possible


# Define hard/soft boundaries (match easyRF, except highest lactate)
rules <- tibble::tribble(
  ~variable, ~hard_lo, ~hard_hi, ~soft_lo, ~soft_hi, ~unit,
  "weight",  20,  500,  22,  150, "kg",
  "height", 120,  240, 150,  200, "cm",
  "systolic_blood_pressure_lowest",  30,  300,  60,  240, "mmHg",
  "fio2_before_randomisation",        0,    1, 0.21,   1, "fraction",
  "max_oxygen_flow_at_randomisation", 0,  100,   0,  60, "L/min",
  "arterial_oxygen_saturation",       0,  100,  70, 100, "%",
  "peripheral_oxygen_saturation",     0,  100,  70, 100, "%",
  "pao2",                              0,   40,   4,  20, "kPa",
  "lactate_highest",                   0,   30, 0.5,  20, "mmol/L",
  "creatinine_highest",                0, 2000,  30, 1500, "Âµmol/L")

# -------------------------------------------------
# 2) Restrict to variables to those present in rules and 
#    - create raw value for reporting (preserves original)
#    - create numeric value with missing detected 
#    - filter on non-missing values
# -------------------------------------------------
EMPRESS_forms_numeric <- EMPRESS_forms_all %>% 
  filter(variable_name %in% rules$variable) %>% 
  mutate(
    value_raw = as.character(value),
    value_num = to_numeric(value_raw)) %>% 
  filter(!is.na(value_num))

# -------------------------------------------------
# 3) Join validation rules and apply rules 
# -------------------------------------------------
EMPRESS_forms_numeric_validation <- EMPRESS_forms_numeric %>% 
  inner_join(
    rules,
    by = c("variable_name" = "variable")
  ) %>% mutate(
    issue_type = case_when(
      value_num < hard_lo | value_num > hard_hi ~ "hard_outlier",
      value_num < soft_lo | value_num > soft_hi ~ "soft_outlier",
      TRUE ~ "ok"
    ),
    source = form_layout
  ) 

# -------------------------------------------------
# 4) Validation report
#    - Change datetimes to local time [Make generic at some point]
# -------------------------------------------------
validation_outliers_boundaries <- EMPRESS_forms_numeric_validation %>% 
  filter(issue_type %in% c("hard_outlier", "soft_outlier")) %>% 
  transmute(
    id = observation_id,
    ssid,
    responsible_site,
    source,
    time_point = paste0(with_tz(start_datetime, "Europe/Copenhagen"),
                        " - ",
                        with_tz(start_datetime, "Europe/Copenhagen")
                        ),
    variable_name,
    value = value_raw,
    issue_type,
    note = 
      case_when(
      issue_type == "hard_outlier" 
      ~ paste0("Outside hard bounds [", hard_lo, ", ", hard_hi, "] ", unit),
      issue_type == "soft_outlier" 
      ~ paste0("Outside soft bounds [", soft_lo, ", ", soft_hi, "] ", unit),
      TRUE ~ NA_character_
      )
    )
```

#### 4.2.2 Outliers by distribution

```{r}
# -------------------------------------------------
# 1) Calculate 1%/99% bounds per variable [Change as needed]
# -------------------------------------------------
pct_bounds <- EMPRESS_forms_numeric %>% 
  group_by(variable_name) %>% 
  summarise(
    p01 = quantile(value_num, 0.01, na.rm = TRUE),
    p99 = quantile(value_num, 0.99, na.rm = TRUE),
    .groups = "drop"
    )

# -------------------------------------------------
# 2) Join and flag outliers 
# -------------------------------------------------
validation_outliers_pct <- EMPRESS_forms_numeric %>% 
  left_join(pct_bounds, by = "variable_name") %>% 
  mutate(
    issue_type = case_when(
      value_num < p01 ~ "low_extreme_1pct",
      value_num > p99 ~ "high_extreme_99pct",
      TRUE ~ NA_character_
    ),
    source = form_layout
  ) %>% 
  filter(!is.na(issue_type))

# -------------------------------------------------
# 3) Validation report
#    - Change datetimes to local time [Make generic at some point]
# -------------------------------------------------
validation_outliers_pct <- validation_outliers_pct %>% 
  transmute(
    id = observation_id, 
    ssid,
    responsible_site,
    source,
    time_point = paste0(with_tz(start_datetime, "Europe/Copenhagen"),
                        " - ",
                        with_tz(start_datetime, "Europe/Copenhagen")
                        ),
    variable_name,
    value = value_raw,
    issue_type,
    note = case_when(
      issue_type == "low_extreme_1pct" ~ "extreme value, below 1% of observations",
      issue_type == "high_extreme_99pct" ~ "extreme value, above 99% of observations",
      TRUE ~ NA_character_
    )
  )

# -------------------------------------------------
# 4) Cleanup
# -------------------------------------------------
rm(
  EMPRESS_forms_numeric,
  EMPRESS_forms_numeric_validation,
  pct_bounds,
  rules
)
```

### 4.3 Missing

```{r}
# -------------------------------------------------
# 1) Validation report for missing
# -------------------------------------------------
validation_missing_values <- EMPRESS_forms_all %>%
  
  # Standardise missing  
  # [As of now, actual confirmed missing (unkowns) and blanks are treated as missing - change if needed. Empty fields in export == not filled]
  
  mutate(
    value_raw = as.character(value),
    value_std = na_blank(value_raw),
    source = form_layout
  ) %>% 
  
  # Validation report
  # - Change datetimes to local time [Make generic at some point]
  filter(is.na(value_std) | value_std == "Unknown") %>% # [Change if needed]
  transmute(
    id = observation_id,
    ssid,
    responsible_site,
    source,
    time_point = paste0(with_tz(start_datetime, "Europe/Copenhagen"),
                        " - ",
                        with_tz(start_datetime, "Europe/Copenhagen")
                        ),
    variable_name,
    value = value_raw,
    issue_type = "missing_value",
    note = "Value is missing / not filled in"
  ) 
```

### 4.4 Date issues

```{r}
# -------------------------------------------------
# 1) Build small anchor table in wide format with observation ids
# -------------------------------------------------
# Get form dates
form_date_vars <- c(
  "date_of_birth",
  "date_of_index_hospital_admission"
)

anchors_date_long <- EMPRESS_forms_all %>%
  filter(variable_name %in% form_date_vars) %>%
  transmute(
    id = observation_id,
    ssid,
    responsible_site,
    source = form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value_date = ymd(na_if(trimws(as.character(value)), ""))
  )

anchors_date_wide <- anchors_date_long %>%
  select(ssid, responsible_site, variable_name, value_date) %>%
  pivot_wider(
    id_cols = c(ssid, responsible_site),
    names_from = variable_name,
    values_from = value_date
  ) %>%
  left_join(
    anchors_date_long %>%
      mutate(var_id = paste0(variable_name, "__id")) %>%
      select(ssid, responsible_site, var_id, id) %>%
      pivot_wider(
        id_cols = c(ssid, responsible_site),
        names_from = var_id,
        values_from = id
      ),
    by = c("ssid", "responsible_site")
  )

# Add randomisation time from master (convert to local time)
anchors <- EMPRESS_master_feasibility %>%
  transmute(
    ssid,
    responsible_site = enrolment_site,
    rand_time_local = with_tz(rand_datetime_utc, "Europe/Copenhagen"),
    rand_date = date(rand_time_local)
  ) %>%
  left_join(anchors_date_wide, by = c("ssid", "responsible_site"))

# -------------------------------------------------
# 2) Build canonical event log (EMPRESS) in long format
# -------------------------------------------------
empress_keep <- c(
  "death",
  "withdrawn_consent_empress",
  "clinical_decision_empress",
  "discontinuation_therapy",
  "involuntary_hospitalisation",
  "sar_susar",
  "susar",
  "consent_from_trial_guardian",
  "consent_from_relative",
  "consent_from_participant",
  "consent_obtained",
  "relocate")


events <- events_master_enrol %>%
  filter(event_type_name %in% empress_keep) %>%
  mutate(
    event_time_local = with_tz(timestamp, "Europe/Copenhagen"),
    id = event_id
  ) %>%
  select(id, ssid, source, responsible_site, event_type_name, event_time_local)

# -------------------------------------------------
# 3) Define event groups
# -------------------------------------------------
eop_susar_events <- c(
  "death",
  "withdrawn_consent",
  "clinical_decision",
  "discontinuation_therapy",
  "involuntary_hospitalisation",
  "sar_susar",
  "susar"
)

relocate_events <- "relocate"

consent_events <- c(
  "consent_from_trial_guardian",
  "consent_from_relative",
  "consent_from_participant",
  "consent_obtained"
)

# -------------------------------------------------
# 4) Validation (set-based)
# -------------------------------------------------
events_with_anchor <- events %>%
  left_join(
    anchors %>% select(ssid, rand_time_local),
    by = "ssid"
  )

# 1) HARD: events before randomisation
issues_before_rand <- events_with_anchor %>%
  filter(!is.na(event_time_local), !is.na(rand_time_local)) %>%
  filter(event_time_local < rand_time_local) %>%
  transmute(
    id,
    ssid,
    responsible_site,
    source,
    time_point = as.character(event_time_local),
    variable = event_type_name,
    value = as.character(event_time_local),
    issue_type = "hard",
    note = paste0(
      "Event time (", event_time_local,
      ") is before randomisation (", rand_time_local, ")"
    )
  )

# 2) HARD: events > 90 days after randomisation
issues_after_90 <- events_with_anchor %>%
  filter(!is.na(event_time_local), !is.na(rand_time_local)) %>%
  filter(event_time_local > rand_time_local + days(90)) %>%
  transmute(
    id,
    ssid,
    responsible_site,
    source,
    time_point = as.character(event_time_local),
    variable = event_type_name,
    value = as.character(event_time_local),
    issue_type = "hard",
    note = paste0(
      "Event time (", event_time_local,
      ") is > 90 days after randomisation (", rand_time_local, ")"
    )
  )

# 3) HARD: events after death
death_time <- events %>%
  filter(event_type_name == "death") %>%
  group_by(ssid) %>%
  summarise(
    death_time = min(event_time_local, na.rm = TRUE),
    .groups = "drop"
  )

issues_after_death <- events %>%
  filter(
    (event_type_name %in% eop_susar_events & event_type_name != "death") |
      event_type_name == "consent_from_participant"
  ) %>%
  left_join(death_time, by = "ssid") %>%
  filter(!is.na(event_time_local), !is.na(death_time)) %>%
  filter(event_time_local > death_time) %>%
  transmute(
    id,
    ssid,
    responsible_site,
    source,
    time_point = as.character(event_time_local),
    variable = event_type_name,
    value = as.character(event_time_local),
    issue_type = "hard",
    note = paste0(
      "Event time (", event_time_local,
      ") is after death time (", death_time, ")"
    )
  )

# -------------------------------------------------
# 5) Baseline validation
# -------------------------------------------------
issues_baseline <- anchors %>%
  rowwise() %>%
  transmute(
    ssid,
    responsible_site,
    issues = list({
      out <- tibble(
        variable = character(),
        issue_type = character(),
        value = character(),
        note = character(),
        id = character()
      )

      add_issue <- function(out, variable, issue_type, value, note, id = NA_character_) {
        bind_rows(
          out,
          tibble(
            variable = variable,
            issue_type = issue_type,
            value = as.character(value),
            note = note,
            id = as.character(id)
          )
        )
      }

      dob <- date_of_birth
      hosp <- date_of_index_hospital_admission
      rdt <- rand_date

      dob_id <- date_of_birth__id
      hosp_id <- date_of_index_hospital_admission__id

      if (!is.na(dob) && dob > Sys.Date()) {
        out <- add_issue(out, "date_of_birth", "hard", dob, "DOB is in the future", dob_id)
      }

      if (!is.na(dob) && !is.na(rdt) && dob > rdt) {
        out <- add_issue(
          out, "date_of_birth", "hard", dob,
          paste0("DOB (", dob, ") is after randomisation date (", rdt, ")"),
          dob_id
        )
      }

      if (!is.na(dob) && !is.na(rdt) && dob <= rdt && interval(dob, rdt) < years(18)) {
        out <- add_issue(
          out, "date_of_birth", "hard", dob,
          paste0("Age < 18 at randomisation date (", rdt, ")"),
          dob_id
        )
      }

      if (!is.na(hosp) && !is.na(dob) && hosp < dob) {
        out <- add_issue(
          out, "date_of_index_hospital_admission", "hard", hosp,
          paste0("Index hospital admission (", hosp, ") before DOB (", dob, ")"),
          hosp_id
        )
      }

      if (!is.na(hosp) && !is.na(rdt) && hosp > rdt) {
        out <- add_issue(
          out, "date_of_index_hospital_admission", "hard", hosp,
          paste0("Index hospital admission (", hosp, ") is after randomisation date (", rdt, ")"),
          hosp_id
        )
      }

      if (!is.na(hosp) && !is.na(rdt) && interval(hosp, rdt) > years(1)) {
        out <- add_issue(
          out, "date_of_index_hospital_admission", "soft", hosp,
          paste0("Hospital admission (", hosp, ") is > 1 year before randomisation (", rdt, ")"),
          hosp_id
        )
      }

      out
    })
  ) %>%
  ungroup() %>%
  unnest(issues) %>%
  filter(!is.na(variable)) %>%
  left_join(
    EMPRESS_forms_all %>%
      transmute(
        id = observation_id,
        source = form_layout,
        time_point = as.character(
          paste0(
            with_tz(start_datetime, "Europe/Copenhagen"),
            " - ",
            with_tz(end_datetime, "Europe/Copenhagen")
          )
        )
      ),
    by = "id"
  ) %>%
  relocate(id, ssid, responsible_site, source, time_point, variable, value, issue_type, note)

# -------------------------------------------------
# 6) Validation report
# -------------------------------------------------

validation_dates <- bind_rows(
  issues_baseline,
  issues_before_rand,
  issues_after_90,
  issues_after_death
)

# -------------------------------------------------
# 7) Cleanup
# -------------------------------------------------

rm(
  anchors,
  anchors_date_long,
  anchors_date_wide,
  issues_baseline,
  death_time,
  events,
  events_with_anchor,
  issues_after_90,
  issues_after_death,
  issues_before_rand,
  consent_events,
  empress_keep,
  form_date_vars,
  eop_susar_events
)
```

### 4.5 Logical issues

#### 4.5.1 Screening / baseline issues

```{r}
# -------------------------------------------------
# 1) Build anchor with relevant baseline / screening vars 
# -------------------------------------------------
# Get relevant vars
screening_vars <- c("use_of_circulatory_support_at_randomisation",
                    "use_of_respiratory_support_at_randomisation",
                    "rrt_within_72h_before_randomisation",
                    "acutely_critically_ill"
                    )

baseline_vars <- c("chronic_rrt",
                  "use_of_respiratory_support_at_randomisation"
                  )

# Build screening and baseline anchor
anchor_screening <- EMPRESS_forms_all %>%
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter(
    form_layout == "empress_domain_screening" & variable_name %in% screening_vars
    )
  
anchor_baseline <- EMPRESS_forms_all %>% 
  filter(
    form_layout == "empress_baseline" & variable_name %in% baseline_vars
    )

# -------------------------------------------------
# 2) Combine anchors while preserving data provenence
# -------------------------------------------------
# Combine anchors
anchor <- bind_rows(anchor_screening, anchor_baseline) %>%
  mutate(
    ssid = as.character(ssid),
    enrolment_site = as.character(responsible_site),
    observation_id = as.character(observation_id),
    source = case_when(
      form_layout == "empress_domain_screening" ~ "screening",
      form_layout == "empress_baseline"  ~ "baseline",
      TRUE ~ NA_character_
    ),
    colname = paste0(source, "__", variable_name)
  )

# Wide values
anchor_wide_vals <- anchor %>%
  select(ssid, enrolment_site, colname, value) %>%
  pivot_wider(
    id_cols = c(ssid, enrolment_site),
    names_from = colname,
    values_from = value,
    values_fill = NA_character_
  )

# Wide observation IDs (suffix columns)
anchor_wide_ids <- anchor %>%
  mutate(colname_id = paste0(colname, "__observation_id")) %>%
  select(ssid, enrolment_site, colname_id, observation_id) %>%
  pivot_wider(
    id_cols = c(ssid, enrolment_site),
    names_from = colname_id,
    values_from = observation_id,
    values_fill = NA_character_
  )

# Combine + parse
bool_cols <- anchor_wide_vals %>% 
  select(-ssid, -enrolment_site) %>% 
  names()

anchor_wide <- anchor_wide_vals %>%
  left_join(anchor_wide_ids, by = c("ssid", "enrolment_site"))

# -------------------------------------------------
# 2) Within anchor validation 
# -------------------------------------------------
# Rule 1) Critically ill, but is not recieving either respiratory or circulatory support
issue_anchor_critically_illness <- anchor_wide %>%
  mutate(
    # Rule violation: A == Yes but neither R nor C == Yes
    rule_violation =
      screening__acutely_critically_ill == "Yes" &
      !(screening__use_of_respiratory_support_at_randomisation == "Yes" |
        screening__use_of_circulatory_support_at_randomisation == "Yes")
  ) %>%
  filter(rule_violation) %>%
  transmute(
    ssid,
    var_1_id = screening__acutely_critically_ill__observation_id,
    var_2_id = screening__use_of_respiratory_support_at_randomisation__observation_id,
    var_3_id = screening__use_of_circulatory_support_at_randomisation__observation_id,
    var_1_site = enrolment_site,
    var_2_site = enrolment_site,
    var_3_site = enrolment_site,
    var_1 = "screening_acutely_critically_ill",
    var_2 = "screening_use_of_respiratory_support_at_randomisation",
    var_3 = "screening_use_of_circulatory_support_at_randomisation",
    value_1 = screening__acutely_critically_ill,
    value_2 = screening__use_of_respiratory_support_at_randomisation,
    value_3 = screening__use_of_circulatory_support_at_randomisation,
    issue_type = "hard",
    note = paste0(
      "Acutely critically ill = ", screening__acutely_critically_ill,
      ". If this is Yes, then at least one of: respiratory support (",
      screening__use_of_respiratory_support_at_randomisation,
      ") or circulatory support (",
      screening__use_of_circulatory_support_at_randomisation,
      ") must be Yes."
    )
  )

# Rule 2) Is respraitory support at screening = Yes and baseline = No or vice versa?
issue_anchor_respiratory_support_screening_vs_baseline <- anchor_wide %>%
  mutate(
    # Rule violation: screening and baseline disagree (Yes vs No)
    rule_violation =
      (screening__use_of_respiratory_support_at_randomisation == "Yes" &
         baseline__use_of_respiratory_support_at_randomisation == "No") |
      (screening__use_of_respiratory_support_at_randomisation == "No" &
         baseline__use_of_respiratory_support_at_randomisation == "Yes")
  ) %>%
  filter(rule_violation) %>%
  transmute(
    ssid,
    var_1_id = screening__use_of_respiratory_support_at_randomisation__observation_id,
    var_2_id = baseline__use_of_respiratory_support_at_randomisation__observation_id,
    var_1_site = enrolment_site,
    var_2_site = enrolment_site,
    var_1 = "screening_use_of_respiratory_support_at_randomisation",
    var_2 = "baseline_use_of_respiratory_support_at_randomisation",
    value_1 = screening__use_of_respiratory_support_at_randomisation,
    value_2 = baseline__use_of_respiratory_support_at_randomisation,
    issue_type = "hard",
    note = paste0(
      "Respiratory support mismatch between screening and baseline: screening = ",
      screening__use_of_respiratory_support_at_randomisation,
      ", baseline = ",
      baseline__use_of_respiratory_support_at_randomisation,
      ". Values should not be opposite (Yes vs No)."
    )
  )
```

#### 4.5.2 Screening / baseline / dayform issues

```{r}
# -------------------------------------------------
# 1) Build first trial day (incept_albumin_dayform_1_to_90) with observation ids
# -------------------------------------------------
# Get relevant vars
day_vars <- c("invasive_mechanical_ventilation",
              "circulatory_support_min_1h"
              )

# First trial dayform day 1 - 90 with relevant vars, long format
first_dayform_1_to_90_long <- ALBUMIN_forms_all %>% 
  filter(form_layout == "incept_albumin_dayform_1_to_90",
         variable_name %in% day_vars
         ) %>% 
  mutate(value_bool = to_bool(value)) %>% 
  arrange(ssid, start_datetime) %>% 
  group_by(ssid) %>% 
  filter(start_datetime == first(start_datetime)) %>% 
  ungroup()

# Pivot values wide
first_dayform_vals<- first_dayform_1_to_90_long %>% 
  select(ssid, responsible_site, start_datetime, 
         end_datetime, variable_name, value_bool) %>% 
  pivot_wider(
    id_cols = c(ssid, responsible_site, start_datetime, end_datetime),
    names_from = variable_name,
    values_from = value_bool
  )

# Pivot oberservation ids wide
first_dayform_ids <- first_dayform_1_to_90_long %>%
  mutate(var_id = paste0(variable_name, "__observation_id")) %>%
  select(ssid, responsible_site, start_datetime, end_datetime, var_id, observation_id) %>%
  pivot_wider(
    id_cols = c(ssid, responsible_site, start_datetime, end_datetime),
    names_from = var_id,
    values_from = observation_id
  )

# Merge 
first_trial_dayform_1_to_90_wide <- first_dayform_vals %>% 
  left_join(first_dayform_ids,
            by = c("ssid", "responsible_site", "start_datetime", "end_datetime")
            ) %>% 
  rename(
    first_instance_mv = invasive_mechanical_ventilation,
    first_instance_mv_obsid = invasive_mechanical_ventilation__observation_id,
    first_instance_circ = circulatory_support_min_1h,
    first_instance_circ_obsid = circulatory_support_min_1h__observation_id
  )

# -------------------------------------------------
# 1) Anchor / dayform cross validation
# -------------------------------------------------


# 1) HARD: Use of MV on at randomisation but not on first instance trial dayform
issues_anchor_day_mv <- anchor_wide %>% 
  left_join(first_trial_dayform_1_to_90_wide,
            by = "ssid") %>% 
  filter(
    screening__use_of_invasive_mechanical_ventilation_at_randomisation %in% TRUE &
    !(first_instance_mv %in% TRUE) # 
  ) %>% 
  transmute(
    ssid,
    var_1_id = screening__use_of_invasive_mechanical_ventilation_at_randomisation__observation_id, 
    var_2_id = first_instance_mv_obsid,
    var_1_site = enrolment_site,
    var_2_site = responsible_site,
    var_1 = "use_of_invasive_mechanical_ventilation_at_randomisation",
    var_2 = "invasive mechanical ventilation",
    value_1 = screening__use_of_invasive_mechanical_ventilation_at_randomisation,
    value_2 = first_instance_mv,
    issue_type = "hard",
    note = paste0(
      "MV at randomisation, so use of MV on day 1 must be TRUE (",
      "MV at randomisation=", screening__use_of_invasive_mechanical_ventilation_at_randomisation,
      "; MV on first day=", first_instance_mv,
      ")." )
  )

# 2) SOFT: Ongiong vasopressor at randomisation but not on first instance trial dayform 

issues_anchor_day_circ <- anchor_wide %>% 
  left_join(first_trial_dayform_1_to_90_wide,
            by = "ssid") %>% 
  filter(
    screening__ongoing_vasopressor_or_inotropic_agent %in% TRUE &
    !(first_instance_circ %in% TRUE) # 
  ) %>% 
  transmute(
    ssid,
    var_1_id = 
      screening__ongoing_vasopressor_or_inotropic_agent__observation_id,
    var_2_id = first_instance_circ_obsid,
    var_1_site = enrolment_site,
    var_2_site = responsible_site,
    var_1 = "ongoing_vasopressor_or_inotropic_agent",
    var_2 = "circulatory support min 1h",
    value_1 = screening__ongoing_vasopressor_or_inotropic_agent,
    value_2 = first_instance_circ,
    issue_type = "soft",
    note = paste0(
      "Vasopressor at randomisation, but not on day 1 (",
      "vasopressor at randomisation = ", screening__ongoing_vasopressor_or_inotropic_agent,
      "; vasopressor on first day = ", first_instance_mv,
      ")." )
  )


# -------------------------------------------------
# 2) Validation report
# -------------------------------------------------

validation_cross_form_logicals<- bind_rows(
  issue_anchor_septic_shock,
  issues_anchor_day_mv,
  issues_anchor_day_circ
) 


# -------------------------------------------------
# Cleanup
# -------------------------------------------------

rm(first_dayform_1_to_90_long,
   first_dayform_ids,
   first_dayform_vals,
   first_trial_dayform_1_to_90_wide,
   issue_anchor_septic_shock,
   issues_anchor_day_circ,
   issues_anchor_day_mv,
   bool_cols,
   baseline_vars,
   screening_vars,
   anchor,
   anchor_baseline,
   anchor_screening,
   anchor_wide,
   anchor_wide_ids,
   anchor_wide_vals)
```

#### 4.5.3 Within dayform issues

```{r}

```
