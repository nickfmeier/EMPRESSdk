---
title: "EMPRESS feasibility script"
author: "NM"
date: "2026-01-15"
output: html_document
---

## 1.0 Load libraries

```{r include=FALSE}
library(nanoparquet)
library(tidyverse)
library(openxlsx)
library(stringi)
library(janitor)
library(uuid)
```

## 2.0 Load data

```{r include=FALSE}
# -------- Paths to exported data files --------
data_dir <- "C:/Users/nmei0013/Downloads"
f_forms <- file.path(data_dir, "export-export_forms_empress_domain_20260120103346.parquet")
f_events <- file.path(data_dir, "export-export_events_empress_platform_20260120103321.parquet")
allocation <- file.path(data_dir, "export-export_allocations_empress_domain_20260120103346.parquet")

# -------- Load data from parquet files --------
EMPRESS_forms <- read_parquet(f_forms)
EMPRESS_events <- read_parquet(f_events)
EMPRESS_allocation <- read_parquet(allocation)
```

## 3.0 Data validation

### 3.x Code for safety report included cut off

```{r eval=FALSE, include=FALSE}
#------------------------------------------------------------
# 1) Cutoff date
#------------------------------------------------------------
Safety_trigger_date <- date("2026-02-18")
cuttoff_date <- Safety_trigger_date - days(105) + 1

#------------------------------------------------------------
# 2) Subset of enrolled participants in EMPRESS <= cuttoff_date
#------------------------------------------------------------
EMPRESS_master_safety <- EMPRESS_events %>% 
  filter(
      event_type_name == "enrolment" &
      event_description == "empress_platform" &
      
    # Local datetime for enrolment before cuttoff date
      date(with_tz(timestamp, "Europe/Copenhagen")) <= cuttoff_date 
  ) %>% 
  
  # Rename timestamp to rand_datetime_utc
  rename(
    rand_datetime_utc = timestamp,
         ) %>% 
  
  # Keep only relevant colums
  select(ssid, enrolment_site, rand_datetime_utc)
```

### 3.1 Creation of master dataframe consisting of 200 first enrolled (feasibility)

```{r}
EMPRESS_master_feasibility <- EMPRESS_events %>% 
  # keep only enrolment rows
  filter(str_detect(event_type_name, "enrolment")) %>% 
  
  # order by time to pick the FIRST 200 enrolled participants
  arrange(timestamp) %>% 
  
  # pick first 200 unique ssid
  distinct(ssid, .keep_all = TRUE) %>% 
  slice_head(n = 200) %>% 
  
  # rename timestamp and event_id
  rename(
    rand_datetime_utc = timestamp,
    rand_datetime_id  = event_id
  ) %>% 
  
  # convert UTC to local datetime
  mutate(
    rand_datetime_local = with_tz(rand_datetime_utc, "Europe/Copenhagen")
  ) %>% 
  
  # keep only relevant columns
  select(
    ssid,
    enrolment_site,
    rand_datetime_utc
  )
```

### 3.2 Removal of unwanted spillovers and uuid

```{r}
#------------------------------------------------------------
# 1) Scan for Pyhton spill-over
#------------------------------------------------------------
py_obj_summary_forms <- EMPRESS_forms %>% 
  mutate(value_chr = as.character(value)) %>% 
  summarise(
    n_py_object = sum(str_detect(value_chr, "<object\\s"), na.rm = TRUE),
    .by = variable_name
  ) %>% 
  filter(n_py_object > 0) %>% 
  arrange(desc(n_py_object))

#------------------------------------------------------------
# 2) Query-ready table of affected rows
#------------------------------------------------------------
py_obj_rows_forms <- EMPRESS_forms %>%
  mutate(value_chr = as.character(value)) %>%
  filter(str_detect(value_chr, "^<object object at 0x[0-9a-fA-F]+>$")) %>%
  transmute(
    ssid, responsible_site, form_layout, start_datetime, end_datetime,
    variable_name, value = value_chr
  )

#------------------------------------------------------------
# 2) Clean forms data from python spill-over
#------------------------------------------------------------
EMPRESS_forms <- EMPRESS_forms %>%
  mutate(
    value_chr = stringr::str_squish(as.character(value)),
    value_chr = dplyr::if_else(
      stringr::str_detect(value_chr, "^<object object at 0x[0-9a-fA-F]+>$"),
      NA_character_,
      value_chr
    ),
    value = value_chr
  ) %>%
  select(-value_chr)

#------------------------------------------------------------
# 3) Scan for UUID
#------------------------------------------------------------
uuid_obj_summary_forms <- EMPRESS_forms %>% 
  mutate(value_chr = str_squish(as.character(value))) %>% 
  summarise(
    n_UUID_object = sum(UUIDvalidate(value_chr), na.rm = TRUE),
    .by = variable_name
  ) %>% 
  filter(n_UUID_object > 0) %>% 
  arrange(desc(n_UUID_object))

#------------------------------------------------------------
# 4) Query-ready table of affected rows
#------------------------------------------------------------
uuid_obj_rows_forms <- EMPRESS_forms %>%
  mutate(value_chr = str_squish(as.character(value))) %>%
  filter(UUIDvalidate(value_chr) == TRUE) %>% 
  transmute(
    ssid, responsible_site, form_layout, start_datetime, end_datetime,
    variable_name, value = value_chr
  )

#------------------------------------------------------------
# 5) Clean forms data from python spill-over
#------------------------------------------------------------
EMPRESS_forms <- EMPRESS_forms %>%
  mutate(
    value_chr = str_squish(as.character(value)),
    value_chr = if_else(
      UUIDvalidate(value_chr) == TRUE, 
      NA_character_,
      value_chr
    ),
    value = value_chr
  ) %>%
  select(-value_chr)

rm(
  py_obj_rows_forms,
  py_obj_summary_forms,
  uuid_obj_rows_forms,
  UUID_obj_summary_forms
)
```

### 3.3 Screening variables subset

```{r}
#------------------------------------------------------------
# 1) Preparing screening subset
#------------------------------------------------------------
EMPRESS_forms_screening <- EMPRESS_forms %>% 
  filter( # relevant form_layout and variables
    form_layout == "empress_domain_screening" & 
    variable_name %in% c(
      # Inclusion criteria
      "age_ge_18",
      "sepsis",
      "acutely_critically_ill",
      "indication_for_empirical_antibiotics",
      # Exclusion criteria
      "infection_multiresistent_bacteria",
      "use_of_valproat",
      "pregnant",
      "suspected_cns_infection",
      "allergic_to_betalactam_antibiotics",
      "preceding_iv_antibiotics",
      "co_enrolment_with_empress_not_possible",
      "informed_content_unobtainable",
      "coercive_measures")
  ) %>% 
  select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value
  )
```

### 3.4 Baseline variables (and baseline-like screening variables) subet

```{r}
#------------------------------------------------------------
# 1) Preparing baseline subset
#------------------------------------------------------------
EMPRESS_forms_baseline <- EMPRESS_forms %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter( 
    # baseline-like variables from screening forms
    (form_layout == "empress_domain_screening" & 
    variable_name %in% c(
      "haematological_or_metastatic_cancer",
      "date_of_birth",
      "acute_surgical_admission",
      "use_of_respiratory_support_at_randomisation",
      "use_of_circulatory_support_at_randomisation",
      "rrt_within_72h_before_randomisation")) |
    # baseline variables
    (form_layout == "empress_baseline" &
    variable_name %in% c(
      "ischemic_heart_disease",
      "diabetes",
      "chronic_pulmonary_disease",
      "chronic_liver_disease",
      "immunosuppression",
      "organ_transplantation",
      "chronic_rrt",
      "sex",
      "clinical_frailty_scale",
      "date_of_index_hospital_admission",
      "department_at_which_the_participant_was_included",
      "weight",
      "heigh",
      "systolic_blood_pressure_lowest",
      "primary_site_of_infection",
      "positive_bacterial_culture",
      "type_of_sample",
      "type_of_bacteria",
      "resistance_to_piperacillin_tazobactam",
      "resistance_to_meropenem",
      "type_of_respiratory_support",
      "fio2_before_randomisation",
      "max_oxygen_flow_at_randomisation",
      "treatment_with_antibacterial_agent_prior_to_randomisation",
      "anti_bacterial_agent",
      "use_of_systemic_corticosteroids_at_randomisation",
      "arterial_blood_gas_available",
      "arterial_oxygen_saturation ",
      "pao2",
      "peripheral_oxygen_saturation",
      "lactate_highest",
      "creatinine_highest",
      "limitations_of_care"))
    ) %>%  
    select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value
    )
```

### 3.5 Dayform variables subset

```{r}
#------------------------------------------------------------
# 1) Preparing dayform subset
#------------------------------------------------------------
EMPRESS_forms_dayforms <- EMPRESS_forms %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter( 
    # baseline form layouts from the export
    form_layout %in% c(
      "empress_dayform_1_to_30",
      "empress_dayform_1_to_90",
      "empress_dayform_non_trial_site_1_to_30",
      "empress_dayform_non_trial_site_1_to_90") &
      variable_name %in% c(
        # Dayform 1 - 30 on non-trial site
        "isolation_due_to_resistant_bacteria",
        "type_of_resistant_bacteria_new",
        "antibiotic_agent_to_which_the_bacteria_was_resistant",
        "invasive_mechanical_ventilation",
        "circulatory_support_min_1h",
        "any_rrt_this_day",
        "anaphylactic_shock_piptazo_meropenem",
        "invasive_fungal_infection",
        "pseudomembranous_colitis",
        "toxic_epidermal_necrolysis",
        
        # Dayform 1 on trial site dayform
        "dosing_regimen",
        
        # Dayform 1 - 30 on trial site
        "did_the_patient_receive_at_least_50percent_of_the_prescribed_daily_dose",
        "reason_for_not_receiving_at_least_50_percent",
        "use_of_any_another_antibiotic_agent_than_allocated_on_this_day",
        "other_antibiotic_agent_than_allocated_type_treatment",
        "other_antibiotic_agent_than_allocated_type_agent",
        
        # Dayform 31 - 90 on both trial and non-trial 
        "invasive_mechanical_ventilation",
        "circulatory_support_min_1h",
        "any_rrt_this_day"
        )
  ) %>%  
  select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value
  )
```

### 3.6 Followup variables subset

```{r}
#------------------------------------------------------------
# 1) Preparing followup 30/90 days subset
#------------------------------------------------------------
EMPRESS_forms_followup <- EMPRESS_forms %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid) %>%  # enrolled participants only
  filter(form_layout == "empress_30_90_days_followup" &
         variable_name == "30_90_day_followup") %>% 
  select(
    observation_id,
    ssid,
    responsible_site,
    form_layout,
    start_datetime,
    end_datetime,
    variable_name,
    value)
```

### 3.7 Combining all subsets

```{r}
#------------------------------------------------------------
# 1) Combining the different dataframes for all participants
#------------------------------------------------------------
EMPRESS_forms_all <- bind_rows(
  EMPRESS_forms_screening,
  EMPRESS_forms_baseline, 
  EMPRESS_forms_dayforms,
  EMPRESS_forms_followup
  )
```

### 3.8 Enrolled events

```{r}
#------------------------------------------------------------
# Subset events on enrolled participants
#------------------------------------------------------------
EMPRESS_events_enrol <- EMPRESS_events %>% 
  filter(ssid %in% EMPRESS_master_feasibility$ssid)
```

## 4.0 Data cleaning

### 4.1 Helper functions

```{r}
# Helper 1: detect missing 
na_blank <- function(x) {
  x <- str_squish(as.character(x))
  x[x %in% c("", "NA", "NaN", "None", "na", "none", "nan")] <- NA_character_
  x
}

# Helper 2: to numeric
to_numeric <- function(x) {

  if (is.numeric(x)) return(x)

  x_chr <- str_to_lower(str_squish(as.character(x)))

  # Explicit missing encodings
  x_chr[x_chr %in% c("", "NA", "NaN", "None", "na", "none", "nan")] <- NA_character_

  # Allow signed numeric values (incl. negatives)
  is_num <- stringr::str_detect(
    x_chr,
    "^[-+]?[0-9]*\\.?[0-9]+$"
  )
  is_num[is.na(is_num)] <- FALSE

  out <- rep(NA_real_, length(x_chr))
  out[is_num] <- as.numeric(x_chr[is_num])

  out
}

# Helper 3
to_bool <- function(x) {
  x <- tolower(trimws(as.character(x)))
  dplyr::case_when(
    x %in% c("true","t","1","yes","y")  ~ TRUE,
    x %in% c("false","f","0","no","n")  ~ FALSE,
    TRUE ~ NA
  )
}
```

### 4.2 Outliers

#### 4.2.1 Outliers by hard/soft boundries

```{r}
# -------------------------------------------------
# 1) Define validation rules for baseline and baseline-like variables
# -------------------------------------------------

# Hard bounds = impossible/outside absolute physiological or data constraints
# Soft bounds = clinically implausible (flag for review), but possible


# Define hard/soft boundaries (match easyRF, except highest lactate)
rules <- tibble::tribble(
  ~variable, ~hard_lo, ~hard_hi, ~soft_lo, ~soft_hi, ~unit,
  
  # Baseline variables
  "weight", 20,  500,  22,  150, "kg", 
  "height", 120,  240, 150,  200, "cm",
  "systolic_blood_pressure_lowest", 30,  300,  75,  200, "mmHg", 
  "crystalloid_volumes_within_24h", 0, 30000, 0, 9999, "mL",
  "lowest_p_albumin_within_24h", 1, 115, 6, 33, "g/L",
  "lactate_highest", 2, 40, 2,  13, "mmol/L", 
    # Changed from easyRF boundaries as plasma lactate >= 2 within 3 hours of randomisation is an inclusion criteria in INCEPT-ALBUMIN. 
  "creatinine_highest", 15, 2500,  26, 590, "Âµmol/L",
  
  # Dayform variables
  "albumin_volume_5percent", 0, 9999, 0, 4999, "mL",
  "albumin_volume_20percent", 0, 9999, 0, 4999, "mL",
  "total_volume_rbc", 0, 29999, 0, 9999, "mL",
  "total_fluid_input", 0, 39999, 0, 9999, "mL",
  "total_fluid_balance", -19999, 19999, -9999, 9999, "mL"
) 

# -------------------------------------------------
# 2) Restrict to variables to those present in rules and 
#    - create raw value for reporting (preserves original)
#    - create numeric value with missing detected 
#    - filter on non-missing values
# -------------------------------------------------

ALBUMIN_forms_numeric <- ALBUMIN_forms_all %>% 
  filter(variable_name %in% rules$variable) %>% 
  mutate(
    value_raw = as.character(value),
    value_num = to_numeric(value_raw)) %>% 
  filter(!is.na(value_num))

# -------------------------------------------------
# 3) Join validation rules and apply rules 
# -------------------------------------------------

ALBUMIN_forms_numeric_validation <- ALBUMIN_forms_numeric %>% 
  inner_join(
    rules,
    by = c("variable_name" = "variable")
  ) %>% mutate(
    issue_type = case_when(
      value_num < hard_lo | value_num > hard_hi ~ "hard_outlier",
      value_num < soft_lo | value_num > soft_hi ~ "soft_outlier",
      TRUE ~ "ok"
    ),
    source = form_layout
  ) 

# -------------------------------------------------
# 4) Validation report
#    - Change datetimes to local time [Make generic at some point]
# -------------------------------------------------
validation_outliers_boundaries <- ALBUMIN_forms_numeric_validation %>% 
  filter(issue_type %in% c("hard_outlier", "soft_outlier")) %>% 
  transmute(
    id = observation_id,
    ssid,
    responsible_site,
    source,
    time_point = paste0(with_tz(start_datetime, "Europe/Copenhagen"),
                        " - ",
                        with_tz(start_datetime, "Europe/Copenhagen")
                        ),
    variable_name,
    value = value_raw,
    issue_type,
    note = 
      case_when(
      issue_type == "hard_outlier" 
      ~ paste0("Outside hard bounds [", hard_lo, ", ", hard_hi, "] ", unit),
      issue_type == "soft_outlier" 
      ~ paste0("Outside soft bounds [", soft_lo, ", ", soft_hi, "] ", unit),
      TRUE ~ NA_character_
      )
    )

validation_outliers_boundaries
```

#### 4.2.2 Outliers by distribution

```{r}

```

### 4.3 Missing 

```{r}

```

### 4.4 Date issues

```{r}

```

### 4.5 Logical issues

#### 4.5.1 Screening / baseline issues

```{r}

```

#### 4.5.2 Screening / baseline / dayform issues

```{r}

```

#### 4.5.3 Within dayform issues

```{r}

```
